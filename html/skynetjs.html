
<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Skynet Dashboard</title>
    <meta name="description" content="SKYNET">
    <meta name="author" content="P.J.Driscoll">
    <link rel='icon' href='favicon.png' sizes='32x32' type='image/png'>
    <link rel='stylesheet' type='text/css' href='style.css'>
</head>
<body>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.7.0/angular.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.7.0/angular-sanitize.js"></script>
    <div ng-app="skynetApp" ng-controller='commandCtrl'>
        <div>
            <div class="left-float">
                <h1>SKYNET Dashboard - {{taskdescription}} {{statusdescription}}</h1>
            </div>
            <div class="right-float">
                <table>
                    <tr>
                        <td class="help-link"><a href="runjs.html">Running Dashboard</a></td>
                        <td class="help-link"><a href="skynetjs.html">Developer Dashboard</a></td>
                        <td class="help-link"><a href="derivationjs.html">Derivation</a></td>
                        <td class="help-link"><a href="changehistoryjs.html">Change History</a></td>
                        <td class="help-link"><a href="explorerjs.html">Object Explorer</a></td>
                        <td class="help-link"><a href="help_index.html">Help</a></td>
                        <td class="help-link"><a href="help_start.html">Get Started</a></td>
                    </tr>
                </table>               
            </div>
        </div>
        
        <p class='clear'>
            <table class='command clear'>
                <tr>
                    <td>
                        <form ng-submit='submit("runjs")'>
                            Run<br>
                            <input type='submit' value='Run'>
                        </form>
                    </td>
                    <td>
                        <form ng-submit='submit("runtoendjs")'>
                            Run to end<br>
                            <input type='submit' value='End'>
                        </form>
                    </td>
                    <td>
                        <form ng-submit='submit("debugjs")'>
                            Run to breakpoint<br>
                            <input type='submit' value='Debug'>
                        </form>
                    </td>
                    <td>
                        <form ng-submit='submit("codebreakjs")'>
                            Code debug break C++<br>
                            <input type='submit' value='Code break'>
                        </form>
                    </td>
                    <td>
                        Rerun current command<br>
                        <button ng-click='submit("rerunjs")'>Rerun</button>
                    </td>
                    <td>
                        <form ng-submit='submit("stepoverjs")'>
                            Step over call<br>
                            <input type='submit' value='Step over'>
                        </form>
                    </td>
                    <td>
                        <form ng-submit='submit("stepintojs")'>
                            Step into call<br>
                            <input type='submit' value='Step into'>
                        </form>
                    </td>
                    <td>
                        <form ng-submit='submit("stepoutjs")'>
                            Step out of call<br>
                            <input type='submit' value='Step out'>
                        </form>
                    </td>
                    <td>
                        <form ng-submit='submit("stepparamjs")'>
                            Step into parameters<br>
                            <input type='submit' value='Step parameter'>
                        </form>
                    </td>
                    <td>
                        <form ng-submit='gotostepcount()'>
                            <details id='gotoid'>
                                <summary>
                                    Goto step count<br>
                                    <input type='submit' value='Goto'><br>
                                </summary>Step count : <br>
                                <input type='text' ng-model='stepcount' name='stepcount'><br>
                            </details>
                        </form>
                    </td>
                    <td>
                        <details id='settingsid'>
                            <summary>
                                Dashboard Settings <br>
                                <button title='Setup' ng-click='settings()' class=''>Settings</button>
                            </summary>
                            <label for="debugstop">Debug level</label><br />
                            <select id="debugstop" ng-model="debugstop" ng-options="option.name for option in debugstopoptions"> </select> <br />
                            Max frames : <br />
                            <input type='text' ng-model='maxstackframes' name='maxstackframes'> <br>
                            Max code : <br />
                            <input type='text' ng-model='maxcode' name='maxcode'> <br>
                            Max derivation : <br>
                            <input type='text' ng-model='maxderivation' name='maxderivation'> <br>
                            Max log : <br>
                            <input type='text' ng-model='maxlog' name='maxlog'>
                        </details>
                    </td>
                    <td>
                        <form ng-submit='submit("quit")'>
                            Abort thread<br>
                            <input type='submit' value='Quit'>
                        </form>
                    </td>
                </tr>
            </table>
        </p>   
        <div>
            <table class='thread'>
                <caption>Threads</caption>
                <tr>
                    <td ng-repeat="sc in stepcounts">
                        <form ng-submit='setthread(sc.threadnum)'>
                            <input type='submit' name='threadnum' value='{{sc.threadnum}} : {{sc.stepcount}}' />
                        </form>
                    </td>
                </tr>
            </table>
        </div>
        <table class='group'>
            <tr>
                <td>
                    <table class='frame'>
                        <caption><pre>{{error.description}}</pre></caption>
                        <tr ng-repeat="ch in error.callhistory">
                            <td>
                                {{ch.purpose}}
                            </td>
                            <td ng-bind-html="trustAsHtml(ch.expression)" init-bind></td>
                            <td>
                                {{ch.logcontext}}
                            </td>
                        </tr>
                    </table>
                    <button title='MIR' ng-click='setbreakpoint(["MIR",3])' ng-class='breakpointclass(["MIR",3])'>Check MIR</button>
                    <button title='Cloned' ng-click='setbreakpoint(["clone",3])' ng-class='breakpointdefaultclass(["clone",3], "NONE")'>Cloned(see log)</button>
                    <button title='User' ng-click='setbreakpoint(["user",22])' ng-class='breakpointclass(["user",22])'>User breakpoint</button>
                    <button title='Error' ng-click='setbreakpoint(["Error",16])' ng-class='breakpointdefaultclass(["Error",16], "NONE")'>Error</button>
                    <button title='Delay' ng-click='setbreakpoint(["Warning",20])' ng-class='breakpointdefaultclass(["Warning",20], "NONE")'>Delay</button>
                    <button title='No constraint' ng-click='setbreakpoint(["Warning",19])' ng-class='breakpointdefaultclass(["Warning",19], "NONE")'>No constraint</button>
                    <button title='Multiple out' ng-click='setbreakpoint(["Warning",23])' ng-class='breakpointdefaultclass(["Warning",23], "NONE")'>Multiple out</button>
                    {{breakpoint}} - {{breakpointdescription}}
                    <details open>
                        <summary>World Sets</summary>
                        <table class='frame'>
                            <tr ng-repeat="ws in worldsets">
                                <td>
                                    {{ws.expression}}
                                </td>
                                <td>
                                    <button ng-repeat="w in ws.worlds" ng-title='w.breakpoint' ng-click='setbreakpoint(w.breakpoint)' ng-class='breakpointdefaultclass(w.breakpoint, w.reason)'>{{w.condition}}</button>
                                </td>
                                <td ng-repeat="cws in ws.childsets">
                                    <button ng-repeat="u in cws.worlds" ng-title='u.breakpoint' ng-click='setbreakpoint(u.breakpoint)' ng-class='breakpointdefaultclass(u.breakpoint, u.reason)'>{{u.condition}}</button>
                                </td>
                            </tr>
                        </table>
                    </details>
                </td>
            </tr>
            <tr>
                <td>
                    <details open>
                        <summary>Delayed Calls</summary>
                        <table class='frame'>
                            <tr ng-repeat="d in delayedcalls">
                                <td ng-bind-html="trustAsHtml(d.expression)" init-bind></td>
                                <td ng-bind-html="trustAsHtml(d.result)" init-bind></td>
                                <td>
                                    <button title='{{["delayed",d.id]}}' ng-click='setbreakpoint(["delayed",d.id])' ng-class='breakpointclass(["delayed",d.id])' ng-bind-html="trustAsHtml(d.cardinality)" init-bind></button>
                                </td>
                                <td>{{d.world}}</td>
                            </tr>
                        </table>
                    </details>
                </td>
            </tr>
            <tr>
                <td>
                    {{breakpoint}}
                    <details open>
                        <summary>Call stack</summary>
                        <table class='frame'>
                            <tr ng-repeat="f in callstack">
                                <td>
                                    {{f.name}}
                                </td>
                                <td>
                                    <div>
                                        <div ng-repeat="d in f.value">
                                            <div class="code" ng-bind-html=" trustAsHtml(d.text)" init-bind><br /></div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    {{f.breakpoint}}
                                </td>
                            </tr>
                        </table>
                    </details>
                </td>
            </tr>
        </table>
        <table class='group'>
            <tr>
                <td>
                    <div class='group'>
                        <table class='stack'>
                            <caption>Detailed stack</caption>
                            <tr ng-repeat="f in frames">
                                <td>
                                    <div style='overflow-x:auto;white-space:nowrap;width:900px'>
                                        <details ng-if="f.hascode">
                                            <summary>
                                                <table class="frameheading">
                                                    <tr>
                                                        <td>{{f.framepos}}</td>
                                                        <td>{{f.function}}</td>
                                                        <td>Step:{{f.stepcount}}</td>
                                                        <td>SMEM:{{f.stackusage}}</td>
                                                        <td ng-bind-html="trustAsHtml(f.contextworld)" init-bind></td>
                                                        <td ng-bind-html="trustAsHtml(f.functioncardinality)" init-bind></td>
                                                        <td></td>
                                                        <td></td>
                                                    </tr>
                                                </table>
                                            </summary>
                                            <div ng-repeat="d in f.value">
                                                <p class="code" ng-bind-html="trustAsHtml(d.text)" init-bind><br /></p>
                                            </div>
                                        </details>
                                        <table class="frameheading" ng-if="!f.hascode">
                                            <tr>
                                                <td>{{f.framepos}}</td>
                                                <td>{{f.function}}</td>
                                                <td>Step:{{f.stepcount}}</td>
                                                <td>SMEM:{{f.stackusage}}</td>
                                                <td ng-bind-html="trustAsHtml(f.contextworld)" init-bind></td>
                                                <td ng-bind-html="trustAsHtml(f.functioncardinality)" init-bind></td>
                                                <td></td>
                                                <td></td>
                                            </tr>
                                        </table>
                                        <table class='frame'>
                                            <tr>
                                                <th ng-repeat="v in f.variables">{{ v.name }}</th>
                                            </tr>
                                            <tr>
                                                <td ng-repeat="v in f.variables">{{ v.typetext }} : <span ng-bind-html="trustAsHtml(v.cardinality)" init-bind></span></td>
                                            </tr>
                                            <tr>
                                                <td ng-repeat="v in f.variables">
                                                    <div class='frame'>
                                                        <div ng-repeat="d in v.value">
                                                            <details ng-if="d.abbreviation">
                                                                <summary>{{d.abbreviation}}...</summary><p ng-bind-html="trustAsHtml(d.text)" init-bind></p>
                                                            </details>
                                                            <div ng-if="!d.abbreviation" ng-bind-html="trustAsHtml(d.text)" init-bind><br /></div>
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                        </table>
                                    </div>
                                </td>
                            </tr>
                        </table>
                    </div>
                </td>
                <td>
                    <div class='group'>
                        <table class='noborder'>
                            <tr>
                                <td>Call</td>
                                <td><button ng-click='setbreakpoint(["Assert",3])' ng-class='breakpointclass(["Assert",3])'>Assert</button></td>
                                <td><button ng-click='setbreakpoint(["PartialAssert",3])' ng-class='breakpointclass(["PartialAssert",3])'>Partial Assert</button></td>
                                <td><button ng-click='setbreakpoint(["Evaluate",3])' ng-class='breakpointclass(["Evaluate",3])'>Evaluate</button></td>
                                <td><button ng-click='setbreakpoint(["PartialEvaluate",3])' ng-class='breakpointclass(["PartialEvaluate",3])'>Partial Evakuate</button></td>
                            </tr>
                            <tr>
                                <td>Return</td>
                                <td><button ng-click='setbreakpoint(["Assert",15])' ng-class='breakpointclass(["Assert",15])'>Assert</button></td>
                                <td><button ng-click='setbreakpoint(["PartialAssert",15])' ng-class='breakpointclass(["PartialAssert",15])'>Partial Assert</button></td>
                                <td><button ng-click='setbreakpoint(["Evaluate",15])' ng-class='breakpointclass(["Evaluate",15])'>Evaluate</button></td>
                                <td><button ng-click='setbreakpoint(["PartialEvaluate",15])' ng-class='breakpointclass(["PartialEvaluate",15])'>Partial Evakuate</button></td>
                            </tr>
                        </table>
                        <br />
                        <details open>
                            <summary>Code</summary>
                            <table class='log'>
                                <tr ng-repeat="l in logexps"><td ng-bind-html="trustAsHtml(l.expression)" init-bind></td></tr>
                            </table>
                        </details>
                        <br />
                        <table class='log'>
                            <caption>Derivation</caption>
                            <tr><td class='log' ng-bind-html="trustAsHtml(derivationhtml)" init-bind></td></tr>
                        </table>
                        <table class='log'>
                            <caption>Logging</caption>
                            <tr ng-repeat="l in logs"><td>{{l.text}}</td></tr>
                        </table>
                    </div>
                </td>
            </tr>
        </table>
    </div>
    <div>
        <p>
            <a href='http://jigsaw.w3.org/css-validator/check/referer'>
                <img style='border:0;width:88px;height:31px'
                     src='http://jigsaw.w3.org/css-validator/images/vcss-blue'
                     alt='Valid CSS!' />
            </a>
        </p>
    </div>
    <script>
        var home = 'http://127.0.0.1/';
        var app = angular.module('skynetApp', ['ngSanitize']);

        app.controller('commandCtrl', function ($scope, $log, $sce, $http, $timeout, $window, $document) {
            $scope.trustAsHtml = $sce.trustAsHtml;
            $scope.threadnum = 0;

            $scope.debugstopoptions = [
                { name: 'none', value: '0' },
                { name: 'end', value: '1' },
                { name: 'task', value: '2' },
                { name: 'error', value: '3' },
                { name: 'warning', value: '4' },
                { name: 'info', value: '5' },
                { name: 'debug', value: '6' },
                { name: 'detail', value: '7' }
            ];

            $scope.debugstop = $scope.debugstopoptions[6];

            // Default settings
            $scope.stepcount = '';
            $scope.maxstackframes = 30;
            $scope.maxcode = 10;
            $scope.maxderivation = 40;
            $scope.maxlog = 0;

            // Protect against requesting data again before data is retrieved.
            $scope.scheduled = 0;

            // Request JSON data sets from the server.
            $scope.initFirst = function () {
                if ($scope.closing) {
                } else if (!$scope.scheduled) {
                    $scope.scheduled = $scope.scheduled + 1;
                    $http.get(home + 'dashboardjs?threadnum=' + $scope.threadnum)
                        .then(function (response) {
                            $scope.threadnum = response.data.threadnum;
                            $scope.breakpoint = response.data.breakpoint;
                            $scope.taskdescription = response.data.taskdescription;
                            $scope.breakpointdescription = response.data.breakpointdescription;
                            $scope.statusdescription = response.data.statusdescription;
                            $scope.running = response.data.running;
                            $scope.closing = response.data.closing;
                            if ($scope.maxstackframes == -1) {
                                $scope.maxstackframes = response.data.maxstackframes;
                            }

                            $scope.scheduled = $scope.scheduled - 1;

                            if ($scope.closing) {
                               $timeout(function () { $scope.initFirst(); }, 5000);
                            } else if ($scope.running) {
                                $timeout(function () { $scope.initFirst(); }, 2000);
                            };
                        });
                    $http.get(home + 'stackjs?threadnum=' + $scope.threadnum + '&maxstackframes=' + $scope.maxstackframes)
                        .then(function (response) {
                            $scope.frames = response.data.records;
                            $scope.callstack = [];
                            for (var i = 0; i < $scope.frames.length; i++) {
                                if ($scope.frames[i].hascode) {
                                    $scope.callstack.push($scope.frames[i]);
                                }
                            }
                        });
                    $http.get(home + 'derivationjs?threadnum=' + $scope.threadnum + '&maxlogentries=' + $scope.maxderivation)
                        .then(function (response) { $scope.derivationhtml = response.data.derivationhtml; });
                    $http.get(home + 'logjs?threadnum=' + $scope.threadnum + '&maxlogentries=' + $scope.maxlog)
                        .then(function (response) { $scope.logs = response.data.records; });
                    $http.get(home + 'logexpjs?threadnum=' + $scope.threadnum + '&maxcode=' + $scope.maxcode)
                        .then(function (response) { $scope.logexps = response.data.records; });
                    $http.get(home + "stepcountjs")
                        .then(function (response) { $scope.stepcounts = response.data.records; });
                    $http.get(home + 'errorjs?threadnum=' + $scope.threadnum + '&maxlogentries=' + $scope.maxcode)
                        .then(function (response) { $scope.error = response.data; });
                    $http.get(home + 'delayedjs?threadnum=' + $scope.threadnum)
                        .then(function (response) { $scope.delayedcalls = response.data.records; });
                    $http.get(home + 'worldsetsjs?threadnum=' + $scope.threadnum)
                        .then(function (response) { $scope.worldsets = response.data.records; });
                };
            };

            // Request an action from the server.
            $scope.submit = function (action) {
                $http.get(home + action + '?threadnum=' + $scope.threadnum + '&stackdepth=' + $scope.stackdepth + '&debugstop=' + $scope.debugstop.value + '&breakpoints=' + Array.from($scope.breakpointCol).join(','))
                    .then(function (response) { $scope.initFirst(); });
            };

            // Switch to a different thread.
            $scope.setthread = function (newthreadnum) {
                if (threadnum != newthreadnum) {
                    $scope.threadnum = newthreadnum;
                    $scope.initFirst();
                }
            };

            // Open/close the goto drop down. On closing, request the server to run to the step count.
            $scope.gotostepcount = function () {
                var field = $document[0].getElementById('gotoid');
                if (field.open) {
                    field.open = 0;
                    $http.get(home + 'gotostepcountjs?threadnum=' + $scope.threadnum + '&stepcount=' + $scope.stepcount)
                        .then(function (response) { $scope.initFirst(); });
                }
                else {
                    field.open = 1;
                    field.focus();
                }
            };

            // Open/close the settings drop down. 
            $scope.settings = function () {
                var field = $document[0].getElementById('settingsid');
                if (field.open) {
                    field.open = 0;
                    $scope.initFirst();
                }
                else {
                    field.open = 1;
                    field.focus();
                }
            };

            // Add or remove the breakpoint from the current breakpoint button
            // From the set of breakpoint button. This also highlights or dehighlights
            // buttons in the same group.
            $scope.breakpointCol = new Set();
            $scope.breakpointGroupCol = new Map();

            $scope.getGroupBreakpoint = function (breakpointCode) {
                var count = $scope.breakpointGroupCol.get(breakpointCode);
                if (count == undefined) {
                    count = 0;
                };
                return count > 0
            }

            $scope.setbreakpoint = function (breakpoint) {
                var breakpointId = breakpoint[0] + "_" + breakpoint[1];
                var breakpointCode = breakpoint[0];
                var count = $scope.breakpointGroupCol.get(breakpointCode);
                if (count == undefined) {
                    count = 0;
                }
                if ($scope.breakpointCol.has(breakpointId)) {
                    $scope.breakpointCol.delete(breakpointId);
                    count--;
                    if (count <= 0) {
                        $scope.breakpointGroupCol.delete(breakpointCode);
                    }
                    else {
                        $scope.breakpointGroupCol.set(breakpointCode, count);
                    }
                }
                else {
                    $scope.breakpointCol.add(breakpointId);
                    count++;
                    $scope.breakpointGroupCol.set(breakpointCode, count);
                }
            };

            // Set default breakpoints.
            $scope.setbreakpoint(["Error", 16]);
            $scope.setbreakpoint(["Warning", 20]);
            $scope.setbreakpoint(["Warning", 19]);
            $scope.setbreakpoint(["Warning", 23]);
            $scope.setbreakpoint(["user", 22]);
            $scope.setbreakpoint(["Assert", 3]);
            $scope.setbreakpoint(["PartialAssert", 3]);
            $scope.setbreakpoint(["Evaluate", 3]);
            $scope.setbreakpoint(["PartialEvaluate", 3]);

            // Create the breakpoint to display a breakpoint button by comparing
            // current breakpoint and call stack in the running code with the
            // breakpoint represented by the breakpoint button.
            // breakpointdefaultclass passes in a default class
            $scope.breakpointclass = function (breakpoint) {
                if (breakpoint == undefined || $scope.breakpoint == undefined) {
                    return "error";
                }
                var breakpointId = breakpoint[0] + "_" + breakpoint[1];
                if ((breakpoint[0] == $scope.breakpoint[0]) && (breakpoint[1] == $scope.breakpoint[1])) {
                    if ($scope.breakpointCol.has(breakpointId)) {
                        return 'breakpointsetat';
                    }
                    return 'breakpointat';
                }
                var eclass = 'breakpointclear';
                if ($scope.frames !== undefined) {
                    $scope.frames.every(function (f) {
                        if ((breakpoint[0] == f.breakpoint[0]) && (breakpoint[1] == f.breakpoint[1])) {
                            if ($scope.breakpointCol.has(breakpointId)) {
                                eclass = 'breakpointsetatstack';
                            } else {
                                eclass = 'breakpointatstack';
                            }
                        }
                        return eclass == 'breakpointclear';
                    });
                }
                if (eclass == 'breakpointclear') {
                    if ($scope.breakpointCol.has(breakpointId)) {
                        eclass = 'breakpointset';
                    } else {
                        var breakpointCode = breakpoint[0];
                        if ($scope.getGroupBreakpoint(breakpointCode)) {
                            eclass = 'breakpointgroupset';
                        }
                    }
                }
                return eclass;
            };

            // Same as breakpoint class but add a default class.
            $scope.breakpointdefaultclass = function (breakpoint, c) {
                return $scope.breakpointclass(breakpoint) + ' ' + c;
            };

            // Initial request for data.
            $scope.initFirst();
        })
        .directive('initBind', function ($compile) {
            return {
                restrict: 'A',
                link: function (scope, element, attr) {
                    attr.$observe('ngBindHtml', function () {
                        if (attr.ngBindHtml) {
                            $compile(element[0].children)(scope);
                        }
                    })
                }
            };
        });
    </script>
</body>
</html>
