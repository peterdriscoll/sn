
<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Skynet Dashboard</title>
    <meta name="description" content="Skynet">
    <meta name="author" content="P.J.Driscoll">
    <link rel='icon' href='favicon.png' sizes='32x32' type='image/png'>
    <link rel='stylesheet' type='text/css' href='style.css'>
</head>
<body>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.7.0/angular.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.7.0/angular-sanitize.js"></script>
    <div ng-app="skynetApp" ng-controller='commandCtrl'>
        <h1>
            Skynet Dashboard - {{taskdescription}} {{statusdescription}}
        </h1>
        <table class='command'>
            <tr>
                <td>
                    <form ng-submit='submit("runjs")'>
                        Run<br>
                        <input type='submit' value='Run'>
                    </form>
                </td>
                <td>
                    <form ng-submit='submit("runtoendjs")'>
                        Run to end<br>
                        <input type='submit' value='End'>
                    </form>
                </td>
                <td>
                    <form ng-submit='submit("debugjs")'>
                        Run to breakpoint<br>
                        <input type='submit' value='Debug'>
                    </form>
                </td>
                <td>
                    <form ng-submit='submit("codebreakjs")'>
                        Code debug break C++<br>
                        <input type='submit' value='Code break'>
                    </form>
                </td>
                <td>
                    <form ng-submit='submit("stepoverjs")'>
                        Step over call<br>
                        <input type='submit' value='Step over'>
                    </form>
                </td>
                <td>
                    <form ng-submit='submit("stepintojs")'>
                        Step into call<br>
                        <input type='submit' value='Step into'>
                    </form>
                </td>
                <td>
                    <form ng-submit='submit("stepoutjs")'>
                        Step out of call<br>
                        <input type='submit' value='Step out'>
                    </form>
                </td>
                <td>
                    <form ng-submit='submit("stepparamjs")'>
                        Step into parameters<br>
                        <input type='submit' value='Step parameter'>
                    </form>
                </td>
                <td>
                    <form ng-submit='gotostepcount()'>
                        <details>
                            <summary>
                                Goto step count<br>
                                <input type='submit' value='Goto'><br>
                            </summary>Step count : <br>
                            <input type='text' ng-model='stepcount' name='stepcount'>
                            <br>
                        </details>
                    </form>
                </td>
                <td>
                    <form ng-submit='initFirst()'>
                        <details>
                            <summary>
                                Max stack frames<br>
                                <input type='submit' value='Stack depth'><br>
                            </summary>Number of stack frames to display :<br>
                            <input type='text' ng-model='maxstackframes' name='maxstackframes'>
                        </details>
                    </form>
                </td>
                <td>
                    <form ng-submit='submit("quit")'>
                        Abort thread<br>
                        <input type='submit' value='Quit'>
                    </form>
                </td>
            </tr>
        </table>
        <div>
            <table class='thread'>
                <caption>Threads</caption>
                <tr>
                    <td ng-repeat="sc in stepcounts">
                        <form ng-submit='setthread(sc.threadnum)'>
                            <input type='submit' name='threadnum' value='{{sc.threadnum}} : {{sc.stepcount}}' />
                        </form>
                    </td>
                </tr>
            </table>
        </div>
        <table class='group'>
            <tr>
                <td>
                    <table class='frame'>
                        <caption><pre>{{error.description}}</pre></caption>
                        <tr ng-repeat="ch in error.callhistory">
                            <td>
                                {{ch.purpose}}
                            </td>
                            <td ng-bind-html="trustAsHtml(ch.expression)" init-bind></td>
                            <td>
                                {{ch.logcontext}}
                            </td>
                        </tr>
                    </table>
                    <button title='MIR' ng-click='setbreakpoint(["MIR",3])' ng-class='breakpointclass(["MIR",3])'>Check MIR</button>
                    <button title='Cloned' ng-click='setbreakpoint(["cloned",3])' ng-class='breakpointdefaultclass(["cloned",3], "NONE")'>Cloned(see log)</button>
                    <button title='User' ng-click='setbreakpoint(["user",22])' ng-class='breakpointclass(["user",22])'>User breakpoint</button>
                    <button title='Error' ng-click='setbreakpoint(["Error",16])' ng-class='breakpointdefaultclass(["Error",16], "NONE")'>Error</button>
                    <button title='Delay' ng-click='setbreakpoint(["Warning",20])' ng-class='breakpointdefaultclass(["Warning",20], "NONE")'>Delay</button>
                    <button title='No constraint' ng-click='setbreakpoint(["Warning",19])' ng-class='breakpointdefaultclass(["Warning",19], "NONE")'>No constraint</button>
                    {{breakpoint}}
                    <table class='frame'>
                        <caption><pre>World Sets</pre></caption>
                        <tr ng-repeat="ws in worldsets">
                            <td>
                                {{ws.expression}}
                            </td>
                            <td>
                                <button ng-repeat="w in ws.worlds" ng-title='w.breakpoint' ng-click='setbreakpoint(w.breakpoint)' ng-class='breakpointdefaultclass(w.breakpoint, w.reason)'>{{w.condition}}</button>
                            </td>
                            <td ng-repeat="cws in ws.childsets">
                                <button ng-repeat="u in cws.worlds" ng-title='u.breakpoint' ng-click='setbreakpoint(u.breakpoint)' ng-class='breakpointdefaultclass(u.breakpoint, u.reason)'>{{u.condition}}</button>
                            </td>
                        </tr>
                    </table>
                </td>
            </tr>
            <tr>
                <td>
                    <table class='frame'>
                        <caption><pre>Delayed Calls</pre></caption>
                        <tr ng-repeat="d in delayedcalls">
                            <td ng-bind-html="trustAsHtml(d.expression)" init-bind></td>
                            <td ng-bind-html="trustAsHtml(d.result)" init-bind></td>
                            <td>
                                {{d.cardinality}}
                            </td>
                        </tr>
                    </table>

                </td>
            </tr>
            <tr>
                <td>
                    <table class='frame'>
                        <caption>Call stack</caption>
                        <tr ng-repeat="f in callstack">
                            <td>
                                {{f.name}}
                            </td>
                            <td>
                                <div>
                                    <div ng-repeat="d in f.value">
                                        <div ng-bind-html="trustAsHtml(d.text)" init-bind><br /></div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                {{f.breakpoint}}
                            </td>
                        </tr>
                    </table>
                </td>
            </tr>
        </table>
        <table class='group'>
            <tr>
                <td>
                    <div class='group'>
                        <table class='stack'>
                            <caption>Detailed stack</caption>
                            <tr ng-repeat="f in frames">
                                <td>
                                    <div style='overflow-x:auto;white-space:nowrap;width:900px'>
                                        <table class='frame'>
                                            <caption>Frame {{ f.typename }} {{ f.name }} : {{ f.function }}</caption>
                                            <tr>
                                                <th ng-repeat="v in f.variables">{{ v.name }}</th>
                                            </tr>
                                            <tr>
                                                <td ng-repeat="v in f.variables">{{ v.typetext }}</td>
                                            </tr>
                                            <tr>
                                                <td ng-repeat="v in f.variables">
                                                    <div class='frame'>
                                                        <div ng-repeat="d in v.value">
                                                            <details ng-if="d.abbreviation">
                                                                <summary>{{d.abbreviation}}...</summary><p ng-bind-html="trustAsHtml(d.text)" init-bind></p>
                                                            </details>
                                                            <div ng-if="!d.abbreviation" ng-bind-html="trustAsHtml(d.text)" init-bind><br /></div>
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                        </table>
                                    </div>
                                </td>
                            </tr>
                        </table>
                    </div>
                </td>
                <td>
                    <div class='group'>
                        <table class='noborder'>
                            <tr>
                                <td>Call</td>
                                <td><button ng-click='setbreakpoint(["assert",3])' ng-class='breakpointclass(["assert",3], breakpoint)'>Assert</button></td>
                                <td><button ng-click='setbreakpoint(["partialassert",3])' ng-class='breakpointclass(["partialassert",3], breakpoint)'>Partial Assert</button></td>
                                <td><button ng-click='setbreakpoint(["evaluate",3])' ng-class='breakpointclass(["evaluate",3], breakpoint)'>Evaluate</button></td>
                                <td><button ng-click='setbreakpoint(["partialevaluate",3])' ng-class='breakpointclass(["partialevaluate",3], breakpoint)'>Partial Evakuate</button></td>
                            </tr>
                            <tr>
                                <td>Return</td>
                                <td><button ng-click='setbreakpoint(["assert",15])' ng-class='breakpointclass(["assert",15])'>Assert</button></td>
                                <td><button ng-click='setbreakpoint(["partialassert",15])' ng-class='breakpointclass(["partialassert",15])'>Partial Assert</button></td>
                                <td><button ng-click='setbreakpoint(["evaluate",15])' ng-class='breakpointclass(["evaluate",15])'>Evaluate</button></td>
                                <td><button ng-click='setbreakpoint(["partialevaluate",15])' ng-class='breakpointclass(["partialevaluate",15])'>Partial Evakuate</button></td>
                            </tr>
                        </table>
                        <br />
                        <table class='log'>
                            <caption>Code</caption>
                            <tr ng-repeat="l in logexps"><td ng-bind-html="trustAsHtml(l.expression)" init-bind></td></tr>
                        </table>
                        <br />
                        <table class='log'>
                            <caption>Logging</caption>
                            <tr ng-repeat="l in logs"><td>{{l.text}}</td></tr>
                        </table>
                    </div>
                </td>
            </tr>
        </table>
    </div>
    <div>
        <p>
            <a href='http://jigsaw.w3.org/css-validator/check/referer'>
                <img style='border:0;width:88px;height:31px'
                     src='http://jigsaw.w3.org/css-validator/images/vcss-blue'
                     alt='Valid CSS!' />
            </a>
        </p>
    </div>
    <script>
        var home = 'http://127.0.0.1/';
        var app = angular.module('skynetApp', ['ngSanitize']);

        app.controller('commandCtrl', function ($scope, $log, $sce, $http, $timeout, $window) {
            $scope.trustAsHtml = $sce.trustAsHtml;
            $scope.threadnum = 0;
            $scope.maxstackframes = -1;
            $scope.pollcount = 0;
            $scope.scheduled = 0;
            $scope.initFirst = function () {
                if ($scope.closing) {
                    $scope.submit('quit');
                    $window.close();
                } else if (!$scope.scheduled) {
                    $scope.scheduled = $scope.scheduled + 1;
                    $http.get(home + 'dashboardjs?threadnum=' + $scope.threadnum)
                        .then(function (response) {
                            $scope.threadnum = response.data.threadnum;
                            $scope.breakpoint = response.data.breakpoint;
                            $scope.taskdescription = response.data.taskdescription;
                            $scope.statusdescription = response.data.statusdescription;
                            $scope.running = response.data.running;
                            $scope.closing = response.data.closing;
                            if ($scope.maxstackframes == -1) {
                                $scope.maxstackframes = response.data.maxstackframes;
                            }

                            $scope.pollcount = $scope.pollcount + 1;
                            $scope.scheduled = $scope.scheduled - 1;

                            if ($scope.closing) {
                               $timeout(function () { $scope.initFirst(); }, 5000);
                            } else if ($scope.running) {
                                $timeout(function () { $scope.initFirst(); }, 2000);
                            };
                        });
                    $http.get(home + 'stackjs?threadnum=' + $scope.threadnum + '&maxstackframes=' + $scope.maxstackframes)
                        .then(function (response) {
                            $scope.frames = response.data.records;
                            $scope.callstack = [];
                            for (var i = 0; i < $scope.frames.length; i++) {
                                if ($scope.frames[i].hascode) {
                                    $scope.callstack.push($scope.frames[i]);
                                }
                            }
                        });
                    $http.get(home + 'logjs?threadnum=' + $scope.threadnum + '&maxlogentries=' + $scope.maxstackframes * 4)
                        .then(function (response) { $scope.logs = response.data.records; });
                    $http.get(home + 'logexpjs?threadnum=' + $scope.threadnum + '&maxlogentries=' + $scope.maxstackframes * 4)
                        .then(function (response) { $scope.logexps = response.data.records; });
                    $http.get(home + "stepcountjs")
                        .then(function (response) { $scope.stepcounts = response.data.records; });
                    $http.get(home + 'errorjs?threadnum=' + $scope.threadnum + '&maxlogentries=' + $scope.maxstackframes * 4)
                        .then(function (response) { $scope.error = response.data; });
                    $http.get(home + 'delayedjs?threadnum=' + $scope.threadnum)
                        .then(function (response) { $scope.delayedcalls = response.data.records; });
                    $http.get(home + 'worldsetsjs?threadnum=' + $scope.threadnum)
                        .then(function (response) { $scope.worldsets = response.data.records; });
                };
            };
            $scope.submit = function (action) {
                $http.get(home + action + '?threadnum=' + $scope.threadnum + '&stackdepth=' + $scope.stackdepth + '&breakpoints=' + Array.from($scope.breakpointCol).join(','))
                    .then(function (response) { $scope.initFirst(); });
            };
            $scope.breakpointCol = new Set();
            $scope.breakpointGroupCol = new Map();
            $scope.getGroupBreakpoint = function (breakpointCode) {
                var count = $scope.breakpointGroupCol.get(breakpointCode);
                if (count == undefined) {
                    count = 0;
                };
                return count > 0
            }
            $scope.setbreakpoint = function (breakpoint) {
                var breakpointId = breakpoint[0] + "_" + breakpoint[1];
                var breakpointCode = breakpoint[0];
                var count = $scope.breakpointGroupCol.get(breakpointCode);
                if (count == undefined) {
                    count = 0;
                }
                if ($scope.breakpointCol.has(breakpointId)) {
                    $scope.breakpointCol.delete(breakpointId);
                    count--;
                    if (count <= 0) {
                        $scope.breakpointGroupCol.delete(breakpointCode);
                    }
                    else {
                        $scope.breakpointGroupCol.set(breakpointCode, count);
                    }
                }
                else {
                    $scope.breakpointCol.add(breakpointId);
                    count++;
                    $scope.breakpointGroupCol.set(breakpointCode, count);
                }
            };
            $scope.setbreakpoint(["Error", 16]);
            $scope.setbreakpoint(["Warning", 20]);
            $scope.setbreakpoint(["Warning", 19]);
            $scope.setbreakpoint(["user", 22]);
            $scope.setbreakpoint(["MIR", 3])
            $scope.setbreakpoint(["assert", 3]);
            $scope.setbreakpoint(["partialassert", 3]);
            $scope.setbreakpoint(["evaluate", 3]);
            $scope.setbreakpoint(["partialevaluate", 3]);
            $scope.breakpointclass = function (breakpoint) {
                if (breakpoint == undefined || $scope.breakpoint == undefined) {
                    return "error";
                }
                var breakpointId = breakpoint[0] + "_" + breakpoint[1];
                if ((breakpoint[0] == $scope.breakpoint[0]) && (breakpoint[1] == $scope.breakpoint[1])) {
                    if ($scope.breakpointCol.has(breakpointId)) {
                        return 'breakpointsetat';
                    }
                    return 'breakpointat';
                }
                var eclass = 'breakpointclear';
                if ($scope.frames !== undefined) {
                    $scope.frames.every(function (f) {
                        if ((breakpoint[0] == f.breakpoint[0]) && (breakpoint[1] == f.breakpoint[1])) {
                            if ($scope.breakpointCol.has(breakpointId)) {
                                eclass = 'breakpointsetatstack';
                            } else {
                                eclass = 'breakpointatstack';
                            }
                        }
                        return eclass == 'breakpointclear';
                    });
                }
                if (eclass == 'breakpointclear'){
                    if ($scope.breakpointCol.has(breakpointId)) {
                        eclass =  'breakpointset';
                    } else {
                        var breakpointCode = breakpoint[0];
                        if ($scope.getGroupBreakpoint(breakpointCode)) {
                            eclass = 'breakpointgroupset';
                        }
                    }
                }
                return eclass;
            };
            $scope.breakpointdefaultclass = function (breakpoint,c) {
                if (breakpoint == undefined || $scope.breakpoint == undefined) {
                    return "error";
                }
                var breakpointId = breakpoint[0] + "_" + breakpoint[1];
                if ((breakpoint[0] == $scope.breakpoint[0]) && (breakpoint[1] == $scope.breakpoint[1])) {
                    if ($scope.breakpointCol.has(breakpointId)) {
                        return 'breakpointsetat ' +c;
                    }
                    return 'breakpointat ' + c;
                }
                var eclass = 'breakpointclear';
                if ($scope.frames !== undefined) {
                    $scope.frames.every(function (f) {
                        if ((breakpoint[0] == f.breakpoint[0]) && (breakpoint[1] == f.breakpoint[1])) {
                            if ($scope.breakpointCol.has(breakpointId)) {
                                eclass = 'breakpointsetatstack';
                            } else {
                                eclass = 'breakpointatstack';
                            }
                        }
                        return eclass == 'breakpointclear';
                    });
                }
                if (eclass == 'breakpointclear') {
                    if ($scope.breakpointCol.has(breakpointId)) {
                        eclass = 'breakpointset';
                    } else {
                        var breakpointCode = breakpoint[0];
                        if ($scope.getGroupBreakpoint(breakpointCode)) {
                            eclass = 'breakpointgroupset';
                        }
                    }
                }
                return eclass + ' ' + c;
            };
            $scope.setthread = function (newthreadnum) {
                if (threadnum != newthreadnum) {
                    $scope.threadnum = newthreadnum;
                    $scope.initFirst();
                }
            };
            $scope.gotostepcount = function () {
                $http.get(home + 'gotostepcountjs?threadnum=' + $scope.threadnum + '&stepcount=' + $scope.stepcount)
                    .then(function (response) { $scope.initFirst(); });
            };
            $scope.initFirst();
        })
            .directive('initBind', function ($compile) {
                return {
                    restrict: 'A',
                    link: function (scope, element, attr) {
                        attr.$observe('ngBindHtml', function () {
                            if (attr.ngBindHtml) {
                                $compile(element[0].children)(scope);
                            }
                        })
                    }
                };
            });
        app.filter('code', function () {
            return function (input) {
                var out = [];
                for (var i = 0; i < input.length; i++) {
                    out.push(input[i]);
                }
                return out;
            }
        });
    </script>
</body>
</html>
